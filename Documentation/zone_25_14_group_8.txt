-- ##########################################################
-- #           GROUP 8: PRODUCT REVIEWS & SUPPORT          #
-- #  Manages product ratings, user feedback, and         #
-- #  customer support tickets.                           #
-- ##########################################################

-- Product Reviews Table (Only Verified Buyers Can Review)
CREATE TABLE product_reviews (
    review_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    product_id UUID REFERENCES products(product_id) ON DELETE CASCADE,
    rating INTEGER NOT NULL CHECK (rating BETWEEN 1 AND 5), -- 1 to 5 stars
    review_text TEXT NULL, -- Optional text review
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Review Images Table (Optional User-Uploaded Images for Reviews)
CREATE TABLE review_images (
    image_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    review_id UUID REFERENCES product_reviews(review_id) ON DELETE CASCADE,
    image_url TEXT NOT NULL
);

-- Support Tickets Table (Users Can Submit Support Requests)
CREATE TABLE support_tickets (
    ticket_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    subject VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    status VARCHAR(20) CHECK (status IN ('open', 'in_progress', 'resolved', 'closed')) DEFAULT 'open',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Support Ticket Responses (Admin Replies)
CREATE TABLE support_ticket_responses (
    response_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    ticket_id UUID REFERENCES support_tickets(ticket_id) ON DELETE CASCADE,
    admin_id UUID REFERENCES users(user_id) ON DELETE CASCADE, -- Only staff can reply
    response_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Ticket Attachments (Optional Images for Support Requests)
CREATE TABLE support_ticket_attachments (
    attachment_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    ticket_id UUID REFERENCES support_tickets(ticket_id) ON DELETE CASCADE,
    image_url TEXT NOT NULL
);

-- User Feedback Table (General Feedback on the Platform)
CREATE TABLE user_feedback (
    feedback_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    feedback_text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Surveys Table (For Collecting Structured Feedback)
CREATE TABLE surveys (
    survey_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Survey Responses Table (Tracks User Answers)
CREATE TABLE survey_responses (
    response_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    survey_id UUID REFERENCES surveys(survey_id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    response JSONB NOT NULL, -- Stores answers in JSON format
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
