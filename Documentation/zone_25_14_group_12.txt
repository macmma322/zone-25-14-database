-- ##########################################################
-- #              GROUP 12: SECURITY & API MONITORING      #
-- #  Tracks critical system changes, API security, and   #
-- #  admin/staff actions for compliance and security.    #
-- ##########################################################

-- Audit Logs Table (Tracks Admin & Staff Actions)
CREATE TABLE audit_logs (
    log_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    admin_id UUID REFERENCES users(user_id) ON DELETE CASCADE,
    action_type VARCHAR(255) NOT NULL, -- Example: 'user_ban', 'price_change', 'role_update'
    target_id UUID NULL, -- Could be user_id, product_id, etc.
    details JSONB DEFAULT '{}', -- Stores additional details of the action
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- API Keys Table (For Secure API Access)
CREATE TABLE api_keys (
    api_key_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(user_id) ON DELETE CASCADE, -- Only admins/devs can generate API keys
    key_value TEXT UNIQUE NOT NULL, -- Securely stored hashed API key
    permissions JSONB DEFAULT '{}', -- Defines API permissions for the key
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- API Usage Logs Table (Tracks API Calls & Requests)
CREATE TABLE api_usage_logs (
    log_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    api_key_id UUID REFERENCES api_keys(api_key_id) ON DELETE CASCADE,
    endpoint TEXT NOT NULL, -- Example: '/v1/users/get'
    request_method VARCHAR(10) NOT NULL CHECK (request_method IN ('GET', 'POST', 'PUT', 'DELETE')),
    request_ip VARCHAR(45) NOT NULL,
    response_status INTEGER NOT NULL,
    response_time_ms INTEGER NOT NULL, -- Stores request processing time in milliseconds
    request_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
